<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Responsive Interactive Audio Spectrum Visualizer</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg1:#0f172a;
    --bg2:#0b1220;
    --glass: rgba(255,255,255,0.06);
    --accent: #8b5cf6;
    --text: #e6eef8;
    --muted: rgba(230,238,248,0.7);
    --glass-border: rgba(255,255,255,0.06);
    --control-height:48px;
  }

  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  .app{
    min-height:100%;
    display:flex;
    flex-direction:column;
    gap:1rem;
    padding:1rem;
  }

  header.site-header{
    display:flex;
    gap:1rem;
    align-items:center;
    justify-content:space-between;
    padding:0.5rem 1rem;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid var(--glass-border);
    backdrop-filter: blur(8px);
  }
  .title{
    display:flex;
    gap:0.75rem;
    align-items:center;
  }
  .title h1{font-size:1.1rem;margin:0;letter-spacing:0.2px}
  .subtitle{font-size:0.85rem;color:var(--muted);margin:0;}

  main {
    display:flex;
    gap:1rem;
    align-items:stretch;
    width:100%;
  }

  /* left: visualizer, right: controls */
  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    border:1px solid var(--glass-border);
    padding:0.75rem;
    flex:1 1 0%;
    display:flex;
    flex-direction:column;
    min-height:320px;
  }

  .canvas-wrap{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
    border-radius:10px;
    background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.15));
    box-shadow: 0 10px 40px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
  }
  canvas{
    width:100%;
    height:100%;
    display:block;
    border-radius:10px;
  }

  .controls-panel{
    width:360px;
    max-width:40%;
    min-width:260px;
    display:flex;
    flex-direction:column;
    gap:0.75rem;
  }

  .group{
    display:flex;
    flex-direction:column;
    gap:0.5rem;
    padding:0.6rem;
    border-radius:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border:1px solid rgba(255,255,255,0.03);
  }
  .group label{font-size:0.77rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
  .row{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;}

  button, .file-label{
    height:var(--control-height);
    min-width:48px;
    border-radius:10px;
    border: 1px solid rgba(255,255,255,0.06);
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    color:var(--text);
    padding:0 12px;
    font-weight:600;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:0.5rem;
    transition:all .18s ease;
  }
  button:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.45);}
  button:active{transform:translateY(0);}

  .primary{background:linear-gradient(90deg,var(--accent),#06b6d4);border:none;color:white}
  .muted{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .toggle{padding:0 10px;height:36px;border-radius:999px;display:inline-flex;align-items:center;gap:6px}

  input[type="file"]{display:none}
  input[type="range"]{width:100%}
  .small{font-size:0.85rem;color:var(--muted)}

  .modes button.active, .themes button.active{outline:3px solid rgba(139,92,246,0.12); transform:scale(1.03);}

  .audio-info{font-size:0.9rem;padding:8px;border-radius:8px;background:rgba(0,0,0,0.18);text-align:center;color:var(--muted)}

  footer.actions{display:flex;gap:0.5rem;align-items:center;justify-content:flex-end;padding-top:0.25rem;}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);padding:10px 16px;border-radius:8px;background:rgba(0,0,0,0.75);color:var(--text);opacity:0;pointer-events:none;transition:all .3s}
  .toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-6px);}

  /* responsive */
  @media (max-width:980px){
    main{flex-direction:column;}
    .controls-panel{width:100%;max-width:100%;}
    .panel{min-height:260px;}
  }

  /* small touch improvements */
  button:focus{outline:2px solid rgba(139,92,246,0.18)}
  .hint{font-size:0.78rem;color:var(--muted)}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Audio spectrum visualizer app">
    <header class="site-header">
      <div class="title">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden style="border-radius:8px;background:linear-gradient(180deg,#7c3aed,#06b6d4);padding:6px;box-shadow:0 6px 20px rgba(2,6,23,0.6)">
          <path d="M3 12h2v6H3zM7 8h2v10H7zM11 4h2v14h-2zM15 2h2v16h-2zM19 6h2v12h-2z" fill="white"/>
        </svg>
        <div>
          <h1>Audio Spectrum Visualizer</h1>
          <p class="subtitle">Responsive ‚Ä¢ Interactive ‚Ä¢ Mobile-ready</p>
        </div>
      </div>

      <div style="display:flex;gap:0.5rem;align-items:center">
        <div class="hint">Shortcuts: <strong>Space</strong> Play/Pause &nbsp; <strong>F</strong> Fullscreen &nbsp; <strong>S</strong> Snapshot</div>
      </div>
    </header>

    <main>
      <section class="panel" aria-label="Visualizer">
        <div class="canvas-wrap" id="canvasWrap">
          <canvas id="visualizerCanvas" role="img" aria-label="Audio visualizer canvas"></canvas>
        </div>

        <div style="display:flex;gap:0.5rem;margin-top:0.6rem;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div class="audio-info" id="audioInfo">No audio loaded</div>

          <div style="display:flex;gap:0.5rem;align-items:center">
            <button id="snapshotBtn" class="muted" title="Download snapshot (S)">üì∑ Snapshot</button>
            <button id="fullscreenBtn" class="muted" title="Toggle fullscreen (F)">‚§¢ Fullscreen</button>
          </div>
        </div>
      </section>

      <aside class="controls-panel" aria-label="Controls">
        <div class="group">
          <label>Audio Source</label>
          <div class="row">
            <label for="audioFile" class="file-label" id="fileLabel" style="cursor:pointer">üìÅ Choose file</label>
            <input id="audioFile" type="file" accept="audio/*" aria-label="Choose audio file" />
            <button id="micBtn" class="muted" title="Use microphone">üé§ Microphone</button>
            <button id="stopMicBtn" class="muted" style="display:none">üõë Stop Mic</button>
          </div>
          <div class="small">Tip: use MP3, WAV, or OGG files. Android/iOS will request permission for mic.</div>
        </div>

        <div class="group">
          <label>Playback Controls</label>
          <div class="row">
            <button id="playBtn" class="primary" disabled>‚ñ∂ Play</button>
            <button id="pauseBtn" class="muted" disabled>‚è∏ Pause</button>
            <button id="stopBtn" class="muted" disabled>‚èπ Stop</button>
          </div>
        </div>

        <div class="group">
          <label>Visualization Mode</label>
          <div class="row modes" role="tablist" aria-label="Visualization modes">
            <button class="muted active" data-mode="bars">üìä Bars</button>
            <button class="muted" data-mode="wave">„Ä∞ Wave</button>
            <button class="muted" data-mode="circular">‚≠ï Circular</button>
            <button class="muted" data-mode="mirror">üîÅ Mirror</button>
          </div>
        </div>

        <div class="group">
          <label>Color Theme</label>
          <div class="row themes">
            <button class="muted active" data-theme="rainbow">üåà Rainbow</button>
            <button class="muted" data-theme="fire">üî• Fire</button>
            <button class="muted" data-theme="ocean">üåä Ocean</button>
            <button class="muted" data-theme="neon">üíú Neon</button>
            <button class="muted" data-theme="mono">‚ö™ Mono</button>
          </div>
        </div>

        <div class="group">
          <label>Volume</label>
          <div class="row" style="align-items:center">
            <input type="range" id="volumeSlider" min="0" max="100" value="70" aria-label="Volume slider" />
            <div class="small" id="volumeValue">70%</div>
          </div>
        </div>

        <div class="group">
          <label>Bar Count</label>
          <div class="row" style="align-items:center">
            <input type="range" id="barCount" min="16" max="256" step="1" value="64" />
            <div class="small" id="barCountValue">64</div>
          </div>
        </div>

        <div class="group">
          <label>FFT Size</label>
          <div class="row" style="align-items:center">
            <select id="fftSelect" style="height:var(--control-height);border-radius:10px;background:transparent;color:var(--text);padding:0 10px">
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128" selected>128</option>
              <option value="256">256</option>
              <option value="512">512</option>
              <option value="1024">1024</option>
              <option value="2048">2048</option>
            </select>
            <div class="small">Higher = more detail, lower = smoother</div>
          </div>
        </div>

        <div class="group">
          <label>Smoothing (0‚Äì1)</label>
          <div class="row" style="align-items:center">
            <input type="range" id="smoothing" min="0" max="0.95" step="0.01" value="0.6" />
            <div class="small" id="smoothingVal">0.60</div>
          </div>
        </div>

        <div class="group">
          <label>Extras</label>
          <div class="row" style="justify-content:space-between">
            <button id="autoRotate" class="muted toggle">üîÅ Rotate</button>
            <button id="glowToggle" class="muted toggle">‚ú® Glow</button>
            <button id="muteBtn" class="muted toggle">üîá Mute</button>
          </div>
        </div>

        <footer class="actions">
          <div class="small hint">Built for responsiveness & mobile</div>
        </footer>
      </aside>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

<script>
(function(){

  /* ------- Utilities ------- */
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const toastEl = $('#toast');
  function showToast(msg, ms=2200){ toastEl.textContent = msg; toastEl.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>toastEl.classList.remove('show'), ms); }

  /* ------- Elements ------- */
  const canvas = $('#visualizerCanvas');
  const canvasWrap = $('#canvasWrap');
  const ctx = canvas.getContext('2d', { alpha: true });
  const audioFile = $('#audioFile');
  const fileLabel = $('#fileLabel');
  const playBtn = $('#playBtn');
  const pauseBtn = $('#pauseBtn');
  const stopBtn = $('#stopBtn');
  const micBtn = $('#micBtn');
  const stopMicBtn = $('#stopMicBtn');
  const audioInfo = $('#audioInfo');
  const modes = $$('.modes button');
  const themes = $$('.themes button');
  const volumeSlider = $('#volumeSlider');
  const volumeValue = $('#volumeValue');
  const barCountInput = $('#barCount');
  const barCountValue = $('#barCountValue');
  const fftSelect = $('#fftSelect');
  const smoothingInput = $('#smoothing');
  const smoothingVal = $('#smoothingVal');
  const snapshotBtn = $('#snapshotBtn');
  const fullscreenBtn = $('#fullscreenBtn');
  const autoRotateBtn = $('#autoRotate');
  const glowToggleBtn = $('#glowToggle');
  const muteBtn = $('#muteBtn');

  /* ------- Audio / WebAudio ------- */
  let audioCtx = null;
  let analyser = null;
  let sourceNode = null;
  let audioElement = new Audio();
  audioElement.crossOrigin = "anonymous";
  audioElement.preload = "metadata";
  audioElement.loop = false;
  let dataArray = null;
  let bufferLength = 0;
  let isPlaying = false;
  let isMicActive = false;
  let micStream = null;
  let animationId = null;

  /* ------- Visual state ------- */
  let vizMode = 'bars';
  let theme = 'rainbow';
  let barCount = parseInt(barCountInput.value,10);
  let smoothingTimeConstant = parseFloat(smoothingInput.value);
  let fftSize = parseInt(fftSelect.value,10);
  let devicePixelRatioCache = window.devicePixelRatio || 1;
  let glowEnabled = false;
  let autoRotate = false;
  let rotateAngle = 0;
  let muted = false;

  /* ------- Canvas Resize Handling (responsive & crisp) ------- */
  function resizeCanvas(){
    const rect = canvasWrap.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    // Only rescale if dpr or size changed to avoid flickers
    canvas.width = Math.max(300, Math.floor(rect.width * dpr));
    canvas.height = Math.max(200, Math.floor(rect.height * dpr));
    canvas.style.width = rect.width + "px";
    canvas.style.height = rect.height + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // scale drawing ops by dpr
  }
  new ResizeObserver(resizeCanvas).observe(canvasWrap);
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  /* ------- Init Audio Context (must be resumed by user gesture) ------- */
  function ensureAudioContext(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(!analyser){
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = fftSize;
      analyser.smoothingTimeConstant = smoothingTimeConstant;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
    }
  }

  /* ------- Connect Audio Element to Analyser ------- */
  function connectMediaElement(){
    if(!audioCtx) ensureAudioContext();
    if(sourceNode) try{ sourceNode.disconnect(); }catch(e){}
    sourceNode = audioCtx.createMediaElementSource(audioElement);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
  }

  /* ------- Connect Microphone Stream ------- */
  async function startMic(){
    try{
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error('Microphone not supported');
      micStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
      ensureAudioContext();
      if(sourceNode) try{ sourceNode.disconnect(); }catch(e){}
      sourceNode = audioCtx.createMediaStreamSource(micStream);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination); // optional: monitor mic sound (can remove to avoid echo)
      isMicActive = true;
      micBtn.style.display = 'none';
      stopMicBtn.style.display = 'inline-flex';
      audioInfo.textContent = "üé§ Microphone Active";
      showToast("Microphone active");
      animate();
    }catch(err){
      console.error(err);
      showToast("Microphone access denied or unavailable");
    }
  }
  function stopMic(){
    if(micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
    if(sourceNode){
      try{ sourceNode.disconnect(); }catch(e){}
      sourceNode = null;
    }
    isMicActive = false;
    micBtn.style.display = 'inline-flex';
    stopMicBtn.style.display = 'none';
    audioInfo.textContent = audioElement.src ? `üéµ ${getFileNameFromUrl(audioElement.src)}` : 'No audio loaded';
    cancelAnimation();
  }

  /* ------- Helpers ------- */
  function getFileNameFromUrl(url){
    try{
      return decodeURIComponent(url.split('/').pop().split('?')[0]) || 'audio';
    }catch(e){ return 'audio'; }
  }
  function cancelAnimation(){
    if(animationId) cancelAnimationFrame(animationId);
    animationId = null;
  }

  /* ------- Drawing Functions ------- */
  function clearCanvas(alpha=0.1){
    const w = canvas.width / (window.devicePixelRatio || 1);
    const h = canvas.height / (window.devicePixelRatio || 1);
    // subtle fade for smooth trails
    ctx.fillStyle = `rgba(0,0,0,${alpha})`;
    ctx.fillRect(0,0,w,h);
  }

  function getThemeColor(valueIndex, total, intensity=1){
    const ratio = (valueIndex / Math.max(1,total));
    switch(theme){
      case 'fire': {
        const hue = 20 + ratio*40; // orange -> yellow
        const lum = 40 + intensity*30;
        return `hsl(${hue}, 90%, ${lum}%)`;
      }
      case 'ocean': {
        const hue = 180 + ratio*40;
        const lum = 35 + intensity*25;
        return `hsl(${hue}, 80%, ${lum}%)`;
      }
      case 'neon': {
        const hue = 270 + ratio*40;
        const lum = 55 + intensity*20;
        return `hsl(${hue}, 90%, ${lum}%)`;
      }
      case 'mono': {
        const g = Math.floor(30 + ratio*200*intensity);
        return `rgb(${g},${g},${g})`;
      }
      default: { // rainbow
        const hue = Math.floor(ratio*360 + (autoRotate ? rotateAngle*10 : 0));
        const lum = 45 + intensity*30;
        return `hsl(${hue}, 95%, ${lum}%)`;
      }
    }
  }

  function drawBars(){
    const w = canvas.width / (window.devicePixelRatio || 1);
    const h = canvas.height / (window.devicePixelRatio || 1);
    const gap = Math.max(1, w / barCount * 0.12);
    const bw = Math.max(2, (w - gap*(barCount+1)) / barCount);

    for(let i=0;i<barCount;i++){
      const dataIdx = Math.floor(i * bufferLength / barCount);
      const v = dataArray[dataIdx] / 255;
      const bh = v * h * 0.85;
      const x = gap + i*(bw+gap);
      const y = h - bh;

      // gradient
      const color = getThemeColor(i, barCount, v);
      ctx.fillStyle = color;
      if(glowEnabled){
        ctx.shadowBlur = Math.max(8, v*30);
        ctx.shadowColor = color;
      } else {
        ctx.shadowBlur = 0;
      }
      ctx.fillRect(x, y, bw, bh);

      // subtle top cap
      ctx.shadowBlur = 0;
      ctx.fillStyle = "rgba(255,255,255,0.03)";
      ctx.fillRect(x, y, bw, Math.min(4,bh));
    }
  }

  function drawWave(){
    const w = canvas.width / (window.devicePixelRatio || 1);
    const h = canvas.height / (window.devicePixelRatio || 1);
    ctx.lineWidth = Math.max(2, Math.min(6, w/200));
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';

    ctx.beginPath();
    const step = Math.max(1, Math.floor(bufferLength / (barCount*1.8)));
    let first=true;
    for(let i=0;i<bufferLength;i+=step){
      const x = (i / bufferLength) * w;
      const v = dataArray[i] / 255;
      const y = h*0.5 + (v - 0.5) * h * 0.9;
      if(first){ ctx.moveTo(x,y); first=false; } else { ctx.lineTo(x,y); }
    }

    // stroke twice to create glow effect
    ctx.strokeStyle = getThemeColor(0,1,0.9);
    if(glowEnabled){ ctx.shadowBlur = 26; ctx.shadowColor = getThemeColor(0,1,0.9); }
    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  function drawCircular(){
    const w = canvas.width / (window.devicePixelRatio || 1);
    const h = canvas.height / (window.devicePixelRatio || 1);
    const cx = w/2, cy = h/2;
    const baseR = Math.min(w,h) * 0.18;
    const maxLen = Math.min(w,h) * 0.35;

    for(let i=0;i<barCount;i++){
      const idx = Math.floor(i * bufferLength / barCount);
      const v = dataArray[idx] / 255;
      const angle = i / barCount * Math.PI*2 + (autoRotate ? rotateAngle*0.01 : 0);
      const len = baseR + v * maxLen;

      const x1 = cx + Math.cos(angle) * baseR;
      const y1 = cy + Math.sin(angle) * baseR;
      const x2 = cx + Math.cos(angle) * len;
      const y2 = cy + Math.sin(angle) * len;

      ctx.lineWidth = Math.max(2, (w / barCount) * 0.9);
      ctx.strokeStyle = getThemeColor(i, barCount, v);
      if(glowEnabled){ ctx.shadowBlur = Math.max(6, v*36); ctx.shadowColor = getThemeColor(i,barCount,v); }
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
      ctx.shadowBlur = 0;
    }

    // center ring
    ctx.beginPath();
    ctx.arc(cx, cy, baseR-2, 0, Math.PI*2);
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.stroke();
  }

  function drawMirror(){
    const w = canvas.width / (window.devicePixelRatio || 1);
    const h = canvas.height / (window.devicePixelRatio || 1);
    const half = h/2;
    const gap = Math.max(1, w / barCount * 0.12);
    const bw = Math.max(2, (w - gap*(barCount+1)) / barCount);

    for(let i=0;i<barCount;i++){
      const idx = Math.floor(i * bufferLength / barCount);
      const v = dataArray[idx] / 255;
      const hlen = v * half * 0.95;
      const x = gap + i*(bw+gap);

      const color = getThemeColor(i, barCount, v);
      ctx.fillStyle = color;
      if(glowEnabled){ ctx.shadowBlur = Math.max(6, v*28); ctx.shadowColor = color; }
      ctx.fillRect(x, half - hlen, bw, hlen);
      ctx.fillRect(x, half, bw, hlen);
      ctx.shadowBlur = 0;
    }

    ctx.beginPath();
    ctx.moveTo(0,half);
    ctx.lineTo(w,half);
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgba(255,255,255,0.04)';
    ctx.stroke();
  }

  /* ------- Main animation loop ------- */
  function animate(){
    if(!analyser) return;
    analyser.getByteFrequencyData(dataArray);

    // fade & optional rotation
    clearCanvas(0.12);

    if(autoRotate){
      rotateAngle += 0.6;
      if(rotateAngle > 360) rotateAngle = 0;
    }

    switch(vizMode){
      case 'bars': drawBars(); break;
      case 'wave': drawWave(); break;
      case 'circular': drawCircular(); break;
      case 'mirror': drawMirror(); break;
      default: drawBars();
    }
    animationId = requestAnimationFrame(animate);
  }

  /* ------- Controls wiring ------- */

  // File input
  fileLabel.addEventListener('click', ()=> audioFile.click());
  audioFile.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    stopMic();
    if(!audioCtx) ensureAudioContext();
    // Chrome requires resume on user gesture
    if(audioCtx.state === 'suspended') await audioCtx.resume();
    const url = URL.createObjectURL(f);
    audioElement.src = url;
    audioElement.load();
    audioElement.volume = volumeSlider.value/100;
    connectMediaElement();
    audioInfo.textContent = `üéµ ${f.name}`;
    playBtn.disabled = false; pauseBtn.disabled = false; stopBtn.disabled = false;
    showToast(`Loaded ${f.name}`);
  });

  // Play / Pause / Stop
  playBtn.addEventListener('click', async ()=>{
    if(!audioElement.src){ showToast('Choose an audio file or use mic'); return; }
    if(!audioCtx) ensureAudioContext();
    if(audioCtx.state === 'suspended') await audioCtx.resume();
    try{
      await audioElement.play();
      isPlaying = true;
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      animate();
      showToast('Playing');
    }catch(err){
      console.error(err);
      showToast('Playback failed (autoplay policy?)');
    }
  });

  pauseBtn.addEventListener('click', ()=>{
    audioElement.pause();
    isPlaying = false;
    playBtn.disabled = false;
    pauseBtn.disabled = true;
    showToast('Paused');
    // don't cancel animation to keep visual idle; but we will cancel to reduce CPU
    cancelAnimation();
  });

  stopBtn.addEventListener('click', ()=>{
    audioElement.pause();
    audioElement.currentTime = 0;
    isPlaying = false;
    playBtn.disabled = false;
    pauseBtn.disabled = true;
    cancelAnimation();
    clearCanvas(1.0);
    showToast('Stopped');
  });

  // Mic controls
  micBtn.addEventListener('click', async ()=>{
    if(!audioCtx) ensureAudioContext();
    if(audioCtx.state === 'suspended') await audioCtx.resume();
    startMic();
  });
  stopMicBtn.addEventListener('click', ()=> stopMic());

  // Modes
  modes.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      modes.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      vizMode = btn.dataset.mode;
      cancelAnimation(); // restart
      if(audioElement.src || isMicActive) animate();
    });
  });

  // Themes
  themes.forEach(btn=>{
    btn.addEventListener('click', ()=> {
      themes.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      theme = btn.dataset.theme;
    });
  });

  // Volume
  volumeSlider.addEventListener('input', (e)=>{
    const val = Number(e.target.value);
    volumeValue.textContent = `${val}%`;
    audioElement.volume = val/100;
    if(val===0){ muteBtn.classList.add('active'); muted=true; } else { muteBtn.classList.remove('active'); muted=false; }
  });

  // Mute toggle
  muteBtn.addEventListener('click', ()=>{
    muted = !muted;
    audioElement.muted = muted;
    if(muted){ muteBtn.classList.add('active'); showToast('Muted'); } else { muteBtn.classList.remove('active'); showToast('Unmuted'); }
  });

  // Bar count
  barCountInput.addEventListener('input', (e)=>{
    barCount = Math.max(8, parseInt(e.target.value,10));
    barCountValue.textContent = barCount;
  });

  // FFT and smoothing
  fftSelect.addEventListener('change', ()=>{
    fftSize = parseInt(fftSelect.value,10);
    if(analyser){
      analyser.fftSize = fftSize;
      bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);
    }
  });
  smoothingInput.addEventListener('input', (e)=>{
    smoothingTimeConstant = parseFloat(e.target.value);
    smoothingVal.textContent = smoothingTimeConstant.toFixed(2);
    if(analyser) analyser.smoothingTimeConstant = smoothingTimeConstant;
  });

  // Snapshot
  snapshotBtn.addEventListener('click', ()=>{
    const link = document.createElement('a');
    link.download = `visualizer-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    showToast('Snapshot saved');
  });

  // Fullscreen
  fullscreenBtn.addEventListener('click', async ()=>{
    const el = document.documentElement;
    if(!document.fullscreenElement) await el.requestFullscreen().catch(()=>{});
    else await document.exitFullscreen().catch(()=>{});
  });

  // Glow toggle
  glowToggleBtn.addEventListener('click', ()=>{
    glowEnabled = !glowEnabled;
    glowToggleBtn.classList.toggle('active', glowEnabled);
  });

  autoRotateBtn.addEventListener('click', ()=>{
    autoRotate = !autoRotate;
    autoRotateBtn.classList.toggle('active', autoRotate);
    showToast(autoRotate ? 'Auto-rotate on' : 'Auto-rotate off');
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space'){ e.preventDefault(); if(isPlaying){ pauseBtn.click(); } else { playBtn.click(); } }
    if(e.key.toLowerCase() === 'f'){ fullscreenBtn.click(); }
    if(e.key.toLowerCase() === 's'){ snapshotBtn.click(); }
  });

  // Audio element ended
  audioElement.addEventListener('ended', ()=>{
    isPlaying = false;
    playBtn.disabled = false;
    pauseBtn.disabled = true;
    cancelAnimation();
    showToast('Playback ended');
  });

  // Keep UI volumes in sync when programmatically changed
  audioElement.addEventListener('volumechange', ()=> {
    volumeSlider.value = Math.floor(audioElement.volume*100);
    volumeValue.textContent = volumeSlider.value + '%';
  });

  // Idle animation: when nothing playing, show a slow, soft visual
  let idleTick = 0;
  function idleAnimation(){
    if(isPlaying || isMicActive || animationId) return;
    clearCanvas(0.22);
    const w = canvas.width / (window.devicePixelRatio || 1);
    const h = canvas.height / (window.devicePixelRatio || 1);
    const count = Math.max(16, Math.floor(w/20));
    for(let i=0;i<count;i++){
      const ph = Math.abs(Math.sin((idleTick*0.02) + i*0.2)) * h * 0.25 + 8;
      const x = i * (w/count);
      ctx.fillStyle = `hsl(${(i/count)*360},40%,60%)`;
      ctx.fillRect(x+4, h/2 - ph/2, (w/count)-8, ph);
    }
    idleTick++;
    requestAnimationFrame(idleAnimation);
  }
  idleAnimation();

  // Restore state on page visibility changes
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ cancelAnimation(); } else { if(isPlaying || isMicActive) animate(); }
  });

  // Small helper for setting up analyser when needed
  function prepareAnalyserIfNeeded(){
    if(!audioCtx) ensureAudioContext();
    if(!analyser) return;
    analyser.fftSize = fftSize;
    analyser.smoothingTimeConstant = smoothingTimeConstant;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
  }

  // Connect mediaElement if audio source changes
  audioElement.addEventListener('play', ()=>{
    if(!audioCtx) ensureAudioContext();
    if(!analyser) {
      analyser = audioCtx.createAnalyser();
    }
    // if not connected, connect
    try{
      // We need to create a new MediaElementSource per audio element only once.
      if(!sourceNode || sourceNode.mediaElement !== audioElement){
        connectMediaElement();
      }
    }catch(e){
      // in some browsers creating multiple sources produces error; re-create audioCtx
      console.warn('recreating audio context due to source creation issue', e);
      audioCtx = null;
      ensureAudioContext();
      connectMediaElement();
    }
  });

  // Ensure analyser reacts to setting changes
  const mutationObserver = new MutationObserver(()=>prepareAnalyserIfNeeded());
  mutationObserver.observe(document.body, { attributes: false, childList: false, subtree: false });

  // Initial values
  barCountValue.textContent = barCount;
  smoothingVal.textContent = smoothingTimeConstant.toFixed(2);

  // Accessibility: announce initial state
  showToast('Visualizer ready ‚Äî choose file or mic');

})();
</script>
</body>
</html>
